#!/bin/sh
# Claude Code notification hook

set -eu

# Replace all control characters (0x00-0x1F) with spaces to ensure valid JSON
# Stop hook's last_assistant_message may contain unescaped control chars
INPUT=$(cat | perl -0777 -pe 's/[\x00-\x1f]/ /g')

CWD=$(printf '%s\n' "$INPUT" | jq -r '.cwd // empty')
HOOK_EVENT=$(printf '%s\n' "$INPUT" | jq -r '.hook_event_name // empty')
SESSION_ID=$(printf '%s\n' "$INPUT" | jq -r '.session_id // "claude"')

if [ "$HOOK_EVENT" = "Stop" ]; then
    TITLE="タスク完了"
    MESSAGE="Claudeに依頼したタスクが完了しました。"
else
    MESSAGE=$(printf '%s\n' "$INPUT" | jq -r '.message // "確認待ち"')
    TITLE=$(printf '%s\n' "$INPUT" | jq -r '.title // "Claude Code"')
fi

REPO_NAME=$(basename "${CWD:-unknown}")

BRANCH=""
if [ -n "$CWD" ] && git -C "$CWD" rev-parse --git-dir >/dev/null 2>&1; then
    BRANCH=$(git -C "$CWD" rev-parse --abbrev-ref HEAD 2>/dev/null || true)
fi

if [ -n "$BRANCH" ]; then
    NOTIFY_TITLE="${REPO_NAME} (${BRANCH})"
else
    NOTIFY_TITLE="${REPO_NAME}"
fi

terminal-notifier \
    -title "$NOTIFY_TITLE" \
    -subtitle "$TITLE" \
    -message "$MESSAGE" \
    -sound default \
    -group "claude-${SESSION_ID}"
